---
title: "Aggregating estimates from multiple fits with custom user data"
output: github_document
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
knitr::opts_chunk$set(echo = TRUE)
library(FPEMcountry)
devtools::load_all()
```



## Introduction
In this vignette we will fit FPET to multiple countries and aggregate the samples to obtain results for aggregate levels. We will fit models for Botswana and Lesotho, country codes 72 and 426 respectively.

## Table of Contents
1. [Fit models](#fit)
2. [Aggregate samples](#run)
3. [Calculate results](#results)

## <a name="fit"></a>
## Fit models

First, fit the models with the function `fit_fp_c`. 
```{r}
first_year <- 1970
last_year <- 2030
union <- "Y"
fit_botswana <- fit_fp_c(
  surveydata_filepath = "D:/git/FPEMcountry/data-raw/Botswana_72_married_example.csv",
  division_numeric_code = 72,
  is_in_union = union,
  first_year = first_year,
  last_year = last_year
)
fit_lesotho <- fit_fp_c(
  surveydata_filepath = "D:/git/FPEMcountry/data-raw/Lesotho_426_married_example.csv",
  division_numeric_code = 426,
  is_in_union = union,
  first_year = first_year,
  last_year = last_year
)
fit_list <- list(fit_botswana, fit_lesotho)
```

## <a name="aggregate"></a>
## Aggregate samples

Within out list of fits we have more complex lists. We only need the samples from these fits. This function plucks the posterior samples and combines each array of samples along index 1 making one large array. The first dimension is for country codes. Use `dimnames()` on the resulting list to see how to index a country. This is the identical format of a posterior samples array from FPEMglobal.
```{r}
posterior_samples <- pluck_abind_fp_c(fit_list)
```

Next, read in your population data and make a single population data set.
```{r}
popdata_botswana <- read.csv("D:/git/FPEMcountry/data-raw/Botswana_72_married_popdata_example.csv")
popdata_lesotho <- read.csv("D:/git/FPEMcountry/data-raw/Lesotho_426_married_popdata_example.csv")
popdata <- rbind(popdata_botswana, popdata_lesotho)
```

Now supply the posterior samples and population count dataset to the function `aggregate_fp`.
```{r}
posterior_samples_aggregated <- aggregate_fp(posterior_samples =  posterior_samples,
                                             population_data = popdata)
```




## <a name="results"></a>
## Calculate results
Finally, supply the aggregated samples, the population data, and the first_year to `calc_fp` to calculate point estimates for family planning indicators.
```{r}
results <- calc_fp(posterior_samples = posterior_samples_aggregated,
                   population_data = popdata,
                   first_year = first_year)
```