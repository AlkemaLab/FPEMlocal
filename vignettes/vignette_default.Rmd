---
title: "..."
output: github_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
# knitr::opts_knit$get("root.dir")  # alternative to the previous line
# the default autosave location will depend on this being setup
options(warn=-1)
```


```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(FPEMcountry)
devtools::load_all()
```

<!-- ## Table of Contents -->
<!-- 1. [Introduction](#intro) -->
<!-- 2. [Run models](#run) -->
<!-- 3. [Post-process](#post-process) -->
<!-- 4. [Plot model results](#plot) -->
 
 
## Installation
The package can be installed by cloning and using `devtools::install()`. The source code for vignettes can be found in [/vignettes](https://github.com/FPcounts/FPEMcountry/tree/master/vignettes). Below is a brief introduction.

## Introduction
This R package is the one-country implementation of FPEM (family planning estimation model) designed with tidyverse philosophy. The model in this package uses global model results from `FPEMglobal` to aid in the estimation of country level family planning indicators. `FPEMcountry` comes complete with survey data, country unit data, and country population count data, to produce one-country runs. Running FPEM is divided into three main wrapper functions.

1. Run a one country model `fpem_one_country`
2. Calculate point estimates for indicators `fpem_results`
3. Plot the  point estimates against the survey data `fpem_plot`

These three functions make running one country FPEM straightforward, while retaining enough division to carry out a variety of developer and client tasks. In this document we will cover the typical use of these three functions.

To start a run we need to know the country code for the country of interest. Our package contains country codes and other country units in the dataset `divisions`. 

```{r}
divisions
```

Our package data sets are tibbles. This is particularly useful for large datasets because it only prints the first few rows. The country codes used by our package, known as `division_numeric_code`, are found in this data. In our example we will execute a one-country run for Afghanistan, code `4`. Survey data is available in the dataset `contraceptive_use`. See `??contraceptive_use` for a detailed description of this dataset.

```{r}
contraceptive_use %>% dplyr::filter(division_numeric_code == 4)
```


## <a name="run"></a>
## Run models
`fpem_one_country` is a wrapper function to run the family planning estimation model. The argument `is_in_union` specifies which model we wish to run. There are two models, one for in-union and another for not-in-union women. These are indicated with `"Y"` and `"N"` respectively. The first_year and last_year arguments determine the years of estimates exported from the run. Regardless of these arguments, the function will use all years in which data is available for estimation. When a survey file is not provided, as in this example, the function uses default package contraceptive_use. The user may also supply optional services statistics.
```{r}
div <- 4
runlist <- fpem_one_country(
  is_in_union = "Y",
  division_numeric_code = div,
  first_year = 1970,
  last_year = 2030,
  diagnostic = TRUE
)
```

`fpem_one_country` returns a list runs. In this case we have one run, in-union women denoted `$y`. This run contain posterior samples and another list called `core_data`. Core data contains processed survey data and run specific data such as the time frame, union, etc.
```{r}
runlist$y$core_data %>% names
```

## Process the samples
`fpem_results` is a wrapper function for calculating point estimates and confidence intervals. By default the function uses package population data (See `population_counts`) in order to calculate family planning indicators. Custom population count data may be supplied (See `??fpem_get_results`).

`fpem_results` utilizes `pmap` from the tidyverse package `purr` allowing it to act on any number of runs. We will supply the entire list of runs from `fpem_one_country`.
```{r}
results <- fpem_results(runlist)
```

Like the previous function, `fpem_results` returns a list of runs. Each run containing a list of tibbles. Each tibble contains point-estimates for a specific family planning indicators in long-format. Selecting the in-union run from the output of `fpem_results` we can inspect the names of the list which are the family planning indicators.
```{r}
results$runy %>% names
```
Let's take a look at the tibble for the indicator `contraceptive_use_modern`
```{r}
results$runy$contraceptive_use_modern
```


## Plot the results
`fpem_get_plots` plots the results of the model against the survey data. The user supplies the objects exported from `fpem_one_country` and `fpem_results` as well as indicators of interest. Indicators of interest are supplied to the argument `indicators`. The argument `compare_to_global` adds point estimate and 95% credible interval from the UNPD global model (See `global_estimates`). The global model estimates are plotted using dotted lines. Since we are only using the default data from UNPD the estimates from our model should align with the UNPD estimates.
```{r}
fpem_plot(
  runlist,
  results,
  indicators = c(
    "unmet_need_any",
    "contraceptive_use_modern",
    "contraceptive_use_traditional",
    "contraceptive_use_any"
    ),
  compare_to_global = TRUE
  )
```


